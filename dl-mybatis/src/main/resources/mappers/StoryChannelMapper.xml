<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.dl.common.dao.story.impl.StoryChannelDaoImpl">
    <resultMap id="BaseResultMap" type="com.dl.common.model.entity.story.StoryChannel" >
		<result column="id" property="id" jdbcType="VARCHAR" />
		<result column="storyId" property="storyId" jdbcType="VARCHAR" />
		<result column="channelCode" property="channelCode" jdbcType="VARCHAR" />
		<result column="status" property="status" jdbcType="VARCHAR" />
		<result column="sort" property="sort" jdbcType="VARCHAR" />
		<result column="createTime" property="createTime" jdbcType="VARCHAR" />
	</resultMap>
	<resultMap id="storyResultMap" type="com.dl.common.model.app.req.StoryResponse" >
		<result column="id" property="id" jdbcType="VARCHAR" />
		<result column="userId" property="userId" jdbcType="VARCHAR" />
		<result column="title" property="title" jdbcType="VARCHAR" />
		<result column="rootId" property="rootId" jdbcType="VARCHAR" />
		<result column="content1" property="content1" jdbcType="VARCHAR" />
		<result column="color1" property="color1" jdbcType="VARCHAR" />
		<result column="content2" property="content2" jdbcType="VARCHAR" />
		<result column="color2" property="color2" jdbcType="VARCHAR" />
		<result column="content3" property="content3" jdbcType="VARCHAR" />
		<result column="color3" property="color3" jdbcType="VARCHAR" />
		<result column="background" property="background" jdbcType="VARCHAR" />
		<result column="isEndingShow" property="isEndingShow" jdbcType="VARCHAR" />
		<result column="createTime" property="createTime" jdbcType="VARCHAR" />
		<association property="user" javaType="com.dl.common.model.entity.user.User">
			<result column="nickName" property="nickName" jdbcType="VARCHAR" />
			<result column="remark" property="remark" jdbcType="VARCHAR" />
			<result column="imgUrl" property="imgUrl" jdbcType="VARCHAR" />
			<result column="remark" property="remark" jdbcType="VARCHAR" />
		</association>
	</resultMap>
	
    <insert id="insert" keyProperty="id" useGeneratedKeys="true">
       INSERT INTO tbl_story_channel
		<trim prefix="(" suffix=")" suffixOverrides="," >
			<if test="id != null and id != ''" >id, </if>
			<if test="storyId != null and storyId != ''" >storyId, </if>
			<if test="channelCode != null and channelCode != ''" >channelCode, </if>
			<if test="status != null and status != ''" >status, </if>
			<if test="sort != null and sort != ''" >sort, </if>
			<if test="createTime != null and createTime != ''" >createTime, </if>
			<if test="createTime == null or createTime == ''">createTime, </if> 
		</trim>
		<trim prefix="values (" suffix=")" suffixOverrides="," >
			<if test="id != null and id != ''" > #{id,jdbcType=VARCHAR}, </if>
			<if test="storyId != null and storyId != ''" > #{storyId,jdbcType=VARCHAR}, </if>
			<if test="channelCode != null and channelCode != ''" > #{channelCode,jdbcType=VARCHAR}, </if>
			<if test="status != null and status != ''" > #{status,jdbcType=VARCHAR}, </if>
			<if test="sort != null and sort != ''" > #{sort,jdbcType=VARCHAR}, </if>
			<if test="createTime != null and createTime != ''" > #{createTime,jdbcType=VARCHAR}, </if>
			<if test="createTime == null or createTime == ''">NOW(),</if>
		 </trim>   
    </insert>

    <insert id="batchInsert" parameterType="java.util.List">
        INSERT INTO tbl_story_channel (id,
            storyId, channelCode, status, sort, createTime
        ) VALUES
		<foreach collection="list" item="item" index="index" separator="," >  
        (	
			#{item.id,jdbcType=VARCHAR},
			#{item.storyId,jdbcType=VARCHAR},  
			#{item.channelCode,jdbcType=VARCHAR},  
			#{item.status,jdbcType=VARCHAR},  
			#{item.sort,jdbcType=VARCHAR},  
			NOW()        
		)
		</foreach>
    </insert>

	<select id="selectById" resultMap="BaseResultMap">
        SELECT id as ID, 
            storyId, channelCode, status, sort, createTime
        FROM tbl_story_channel
		WHERE id = #{id,jdbcType=VARCHAR}
    </select>
	
	<select id="selectList" resultMap="BaseResultMap">
        SELECT id as ID, 
            storyId, channelCode, status, sort, createTime
        FROM tbl_story_channel
		<where>1=1
            <if test="storyId != null and storyId != '' ">and storyId = #{storyId} </if>
            <if test="channelCode != null and channelCode != '' ">and channelCode = #{channelCode} </if>
            <if test="status != null and status != '' ">and status = #{status} </if>
            <if test="sort != null and sort != '' ">and sort = #{sort} </if>
            <if test="createTime != null and createTime != '' ">and createTime = #{createTime} </if>
		</where>
    </select>
	
    <update id="update" parameterType="com.dl.common.model.entity.story.StoryChannel">
        UPDATE tbl_story_channel
        <set>
            <if test="storyId != null and storyId != '' "> storyId = #{storyId}, </if>
            <if test="channelCode != null and channelCode != '' "> channelCode = #{channelCode}, </if>
            <if test="status != null and status != '' "> status = #{status}, </if>
            <if test="sort != null and sort != '' "> sort = #{sort}, </if>
            <if test="createTime != null and createTime != '' "> createTime = #{createTime}, </if>
        </set>
        WHERE id = #{id}
    </update>
	
	<update id="batchUpdate" parameterType="java.util.List">
		<foreach collection="list" item="item" index="index" separator=";">
			UPDATE tbl_story_channel
			<set>
				<if test="storyId != null and storyId != '' "> storyId = #{item.storyId}, </if>
				<if test="channelCode != null and channelCode != '' "> channelCode = #{item.channelCode}, </if>
				<if test="status != null and status != '' "> status = #{item.status}, </if>
				<if test="sort != null and sort != '' "> sort = #{item.sort}, </if>
				<if test="createTime != null and createTime != '' "> createTime = #{item.createTime}, </if>
			</set>
			WHERE id = #{item.id}
		</foreach>
    </update>
	
    <delete id="deleteById">
        DELETE FROM tbl_story_channel
        WHERE id = #{id,jdbcType=VARCHAR}
    </delete>

    <delete id="batchDelete">
		<foreach collection="list" item="item" index="index" separator=";">
			DELETE FROM tbl_story_channel
			WHERE id = #{item.id,jdbcType=VARCHAR}
		</foreach>
    </delete>
	
	<delete id="deleteByStoryId">
		delete from tbl_story_channel
		where storyId = #{storyId,jdbcType=VARCHAR}
	</delete>
	
	<!-- 根据板块查询指定时间段，审批通过的故事列表 -->
	<select id="selectStoryListByCodeAndTime" parameterType="java.util.Map" resultMap="storyResultMap">
		select t1.storyId as id,t2.title as title,t2. rootId as rootId,
			t2.content1 as content1,t2.color1 as color1,
			t2.content2 as content2,t2.color2 as color2,
			t2.content3 as content3,t2.color3 as color3,
			t2.isEndingShow as isEndingShow,t2.background as background,
			t3.id as userId,t3.nickName as nickName,t3.imgUrl as imgUrl,
			t2.createTime as createTime
		from tbl_story_channel t1
		left join tbl_story t2 on t1.storyId = t2.id
		left join tbl_user t3 on t2.userId = t3.id
		where t1.channelCode = #{channelCode,jdbcType=VARCHAR} and t2.`status` = 2 and t2.allowShow = 1 
			and t2.createTime <![CDATA[ >= ]]> #{beginTime,jdbcType=VARCHAR} AND t2.createTime <![CDATA[ < ]]> #{endTime,jdbcType=VARCHAR}
		order by t2.createTime desc
	</select>
	
	<!-- 根据板块查询指定条数，审批通过的故事列表 -->
	<select id="selectStoryListByCodeAndLimit" parameterType="java.util.Map" resultMap="storyResultMap">
		select t1.storyId as id,t2.title as title,t2. rootId as rootId,
			t2.content1 as content1,t2.color1 as color1,
			t2.content2 as content2,t2.color2 as color2,
			t2.content3 as content3,t2.color3 as color3,
			t2.isEndingShow as isEndingShow,t2.background as background,
			t3.id as userId,t3.nickName as nickName,t3.imgUrl as imgUrl,
			t2.createTime as createTime
		from tbl_story_channel t1
		left join tbl_story t2 on t1.storyId = t2.id
		left join tbl_user t3 on t2.userId = t3.id
		where t1.channelCode = #{channelCode,jdbcType=VARCHAR} and t2.`status` = 2 and t2.allowShow = 1 
		order by t2.createTime desc
		limit 0,${limit}
	</select>
	
	<!-- 根据板块查询指定条数，page分页 -->
	<select id="selectStoryListByPage" resultMap="storyResultMap">
		select t1.storyId as id,t2.title as title,t2. rootId as rootId,
			t2.content1 as content1,t2.color1 as color1,
			t2.content2 as content2,t2.color2 as color2,
			t2.content3 as content3,t2.color3 as color3,
			t2.isEndingShow as isEndingShow,t2.background as background,
			t3.id as userId,t3.nickName as nickName,t3.imgUrl as imgUrl,
			t3.remark as remark, t2.createTime as createTime
		from tbl_story_channel t1
		left join tbl_story t2 on t1.storyId = t2.id
		left join tbl_user t3 on t2.userId = t3.id
		where t1.channelCode = #{channelCode,jdbcType=VARCHAR} and t2.`status` = 2 and t2.allowShow = 1 
		order by t2.createTime desc
		limit #{index},#{pageSize}
	</select>
</mapper>